# RC 탱크 프로젝트

Bluepad32를 이용한 게임패드 조작 RC 탱크입니다.

## 기능

- **게임패드 연결**: Bluepad32를 통한 블루투스 게임패드 연결
- **트랙 제어**: 좌측 스틱 Y축으로 좌측 트랙, 우측 스틱 Y축으로 우측 트랙 독립 제어
- **터렛 제어**: D-PAD 좌우로 터렛 회전
- **포 마운트 제어**: D-PAD 상하로 포 마운트 각도 조절
- **포신 발사**: B 버튼으로 포신 당기기 (LED 깜빡임 + 효과음 2, 200ms)
- **기관총 발사**: A 버튼으로 기관총 발사 (LED 점멸 + 효과음 3, 1초간)
- **헤드라이트**: L2 + R2 버튼으로 헤드라이트 ON/OFF
- **볼륨 조절**: L1 + (X 또는 Y) 버튼으로 볼륨 감소, R1 + (X 또는 Y) 버튼으로 볼륨 증가 (EEPROM 저장, 100ms 간격)
- **속도 조절**: X/Y 버튼 + D-PAD로 좌우 트랙 속도 배율 조절 (EEPROM 저장)
- **버튼 스왑**: L1 + R1 버튼 3초간 누르면 A/B, X/Y 버튼 매핑 변경 (EEPROM 저장)
- **EEPROM 초기화**: Select + Start 버튼 3초간 누르면 모든 설정 초기화 및 재시작
- **효과음**: DFPlayer를 통한 SD카드 효과음 재생

## 하드웨어 연결

### ESP32 핀 연결

| ESP32 핀 | 연결 대상 | 설명 |
|---------|-----------|------|
| GPIO 4  | 포신 LED | 포신/기관총 발사 시 깜빡임 |
| GPIO 16 | 헤드라이트 LED | 헤드라이트 제어 |
| GPIO 13 | 우측 트랙 IN2 | DRV8833 우측 트랙 제어 |
| GPIO 18 | 포신 서보 모터 | 포신 당기기 제어 (B 버튼) |
| GPIO 19 | 포 마운트 서보 모터 | 포 마운트 각도 제어 (D-PAD 상하) |
| GPIO 21 | 터렛 모터 IN2 | DRV8833 터렛 제어 |
| GPIO 22 | 터렛 모터 IN1 | DRV8833 터렛 제어 |
| GPIO 25 | 좌측 트랙 IN1 | DRV8833 좌측 트랙 제어 |
| GPIO 26 | 좌측 트랙 IN2 | DRV8833 좌측 트랙 제어 |
| GPIO 27 | 우측 트랙 IN1 | DRV8833 우측 트랙 제어 |
| GPIO 32 | DFPlayer RX | DFPlayer 통신 |
| GPIO 33 | DFPlayer TX | DFPlayer 통신 |

### DRV8833 모터 드라이버 연결

#### 좌측 트랙 (DRV8833 #1)
- AIN1 → GPIO 25
- AIN2 → GPIO 26
- AOUT1 → 좌측 트랙 모터 1
- AOUT2 → 좌측 트랙 모터 2
- VM → 12V 전원
- GND → 공통 접지
- VCC → 3.3V (논리 전원)

#### 우측 트랙 (DRV8833 #1)
- BIN1 → GPIO 27
- BIN2 → GPIO 13
- BOUT1 → 우측 트랙 모터 1
- BOUT2 → 우측 트랙 모터 2

#### 터렛 (DRV8833 #2)
- AIN1 → GPIO 22
- AIN2 → GPIO 21
- AOUT1 → 터렛 모터 +
- AOUT2 → 터렛 모터 -
- VM → 12V 전원
- GND → 공통 접지
- VCC → 3.3V (논리 전원)

### 서보 모터 연결

#### 포 마운트 서보 모터 (각도 조절)
- **신호선**: GPIO 19
- **전원**: 5V
- **접지**: 공통 접지
- **기능**: D-PAD 상하로 포 마운트 각도 조절

#### 포신 서보 모터 (당기기)
- **신호선**: GPIO 18
- **전원**: 5V
- **접지**: 공통 접지
- **기능**: B 버튼으로 포신 당기기 (A/B 버튼이 뒤바뀜)

### DFPlayer Mini 연결

- RX → GPIO 33
- TX → GPIO 32
- VCC → 5V
- GND → 공통 접지
- SPK_1, SPK_2 → 스피커

## SD카드 설정

SD카드에 다음 파일들을 저장하세요:

```
sdcard/
├── 0001.mp3  (효과음 1 - 대기 시 반복 재생)
├── 0002.mp3  (효과음 2 - 포신 발사 시 재생)
├── 0003.mp3  (효과음 3 - 기관총 발사 시 재생)
└── 0004.mp3  (효과음 4 - 게임 패드 연결 시 재생)
```

## 게임패드 조작법

### 기본 조작
- **좌측 스틱 Y축**: 좌측 트랙 전후진 제어
- **우측 스틱 Y축**: 우측 트랙 전후진 제어
- **D-PAD 좌우**: 터렛 좌우 회전
- **D-PAD 상하**: 포 마운트 상하 각도 조절 (75~110도 범위)

### 버튼 조작
- **B 버튼**: 포신 당기기 (LED 깜빡임 + 효과음 2 재생, 200ms)
- **A 버튼**: 기관총 발사 (LED 점멸 + 효과음 3 재생, 1초간)
- **L2 + R2 버튼**: 헤드라이트 ON/OFF 토글

### 속도 조절
- **X 버튼 + D-PAD 위**: 좌측 트랙 속도 배율 증가 (+0.02)
- **X 버튼 + D-PAD 아래**: 좌측 트랙 속도 배율 감소 (-0.02)
- **Y 버튼 + D-PAD 위**: 우측 트랙 속도 배율 증가 (+0.02)
- **Y 버튼 + D-PAD 아래**: 우측 트랙 속도 배율 감소 (-0.02)

**배율 범위**: 0.1~2.0 (0.1 = 10% 속도, 1.0 = 100% 속도, 2.0 = 200% 속도)

**볼륨 조절 감도**: 100ms 간격으로 변경 (기존 200ms에서 개선)

*속도 배율 설정은 EEPROM에 자동 저장되어 다음 시작 시에도 유지됩니다.*

### 볼륨 조절
- **L1 + (X 또는 Y) 버튼**: 볼륨 감소 (1-30 범위, 100ms 간격)
- **R1 + (X 또는 Y) 버튼**: 볼륨 증가 (1-30 범위, 100ms 간격)

*볼륨 설정은 버튼을 뗐을 때 EEPROM에 자동 저장되어 다음 시작 시에도 유지됩니다.*

### 고급 설정
- **L1 + R1 버튼 3초간 누르기**: A/B, X/Y 버튼 매핑 스왑 토글
  - 기본 상태: A=기관총, B=포신, X=좌측속도, Y=우측속도
  - 스왑 상태: A=포신, B=기관총, X=우측속도, Y=좌측속도
  - 설정은 EEPROM에 저장되어 재시작 후에도 유지됩니다
- **Select + Start 버튼 3초간 누르기**: 모든 EEPROM 설정 초기화 및 ESP32 재시작

### LED 동작
- **포신 발사 시**: 포신 LED 100ms 간격으로 깜빡임 (200ms 동안)
- **기관총 발사 시**: 포신 LED 500ms 간격으로 점멸 (1초간)
- **헤드라이트**: R1 버튼으로 ON/OFF 토글

### 게임패드 피드백
- **포신 발사 시**: 게임패드 진동 (400ms)
- **기관총 발사 시**: 게임패드 진동 (300ms)
- **버튼 스왑 변경 시**: 게임패드 진동 (600ms)
- **EEPROM 초기화 시**: 게임패드 진동 (800ms)
- **볼륨 변경 시**: 시리얼 로그로 확인
- **포 마운트 각도**: 75~110도 범위로 제한 (기존 0~180도에서 개선)
- **포신 발사 시간**: 200ms로 단축 (기존 500ms에서 개선)

## 컴파일 및 업로드

1. PlatformIO IDE에서 프로젝트를 열기
2. 필요한 라이브러리들이 자동으로 설치됩니다
3. ESP32 보드를 연결하고 업로드
4. 시리얼 모니터로 초기화 과정 확인

## 초기화 과정

1. ESP32 부팅
2. EEPROM에서 속도 설정, 버튼 스왑 설정, 볼륨 설정 로드
3. 서보 모터 초기화 (포 마운트: 90도, 포신: 90도)
4. DFPlayer 초기화 및 효과음 1 재생 시작
5. Bluepad32 초기화
6. 게임패드 연결 대기

## 게임패드 연결

1. ESP32 부팅 후 블루투스 페어링 모드 진입
2. 게임패드에서 블루투스 설정으로 ESP32 연결
3. 연결 성공 시 효과음 4 재생 및 효과음 1 재생 중단
4. 게임패드 조작 가능

## 게임패드 조작 요약

| 조작 | 기능 | 비고 |
|------|------|------|
| **좌측 스틱 Y축** | 좌측 트랙 전후진 | 독립 제어 |
| **우측 스틱 Y축** | 우측 트랙 전후진 | 독립 제어 |
| **D-PAD 좌우** | 터렛 회전 | 좌우 회전 |
| **D-PAD 상하** | 포 마운트 각도 | 75~110도 |
| **A 버튼** | 기관총 발사 | 1초간, LED 점멸 |
| **B 버튼** | 포신 발사 | 200ms, LED 깜빡임 |
| **X 버튼 + D-PAD** | 좌측 트랙 속도 조절 | 배율 0.1~2.0 |
| **Y 버튼 + D-PAD** | 우측 트랙 속도 조절 | 배율 0.1~2.0 |
| **L1 + (X 또는 Y) 버튼** | 볼륨 감소 | 1-30 범위 |
| **R1 + (X 또는 Y) 버튼** | 볼륨 증가 | 1-30 범위 |
| **L2 + R2 버튼** | 헤드라이트 토글 | ON/OFF |
| **L1 + R1 (3초)** | 버튼 스왑 토글 | A/B, X/Y 매핑 변경 |
| **Select + Start (3초)** | EEPROM 초기화 | 재시작 |

## 문제 해결

### 게임패드가 연결되지 않는 경우
- ESP32 재부팅 후 다시 시도
- 게임패드 페어링 정보 초기화 후 재연결

### 모터가 작동하지 않는 경우
- 전원 공급 확인 (12V)
- DRV8833 연결 확인
- PWM 채널 설정 확인

### 효과음이 나오지 않는 경우
- SD카드 파일명 확인 (0001.mp3, 0002.mp3 등)
- DFPlayer 연결 확인 (GPIO 32, 33)
- 볼륨 설정 확인 (코드에서 20으로 설정)

### 서보 모터가 작동하지 않는 경우
- 서보 모터 전원 공급 확인 (5V)
- 서보 신호선 연결 확인 (GPIO 18, GPIO 19)
- ESP32Servo 라이브러리 설치 확인

## 라이센스

이 프로젝트는 MIT 라이센스 하에 배포됩니다.
